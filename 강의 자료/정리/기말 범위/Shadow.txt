▶ 그림자
그림자는 시각적 공간적 현실감을 느낄 수 있도록 함

▶ 원형 그림자
D3D12_BLEND_ZERO
D3D12_BLEND_INV_SRC_COLOR
D3D12_BLEND_OP_ADD

▶ 평면 투영 그림자
조명에서 정점을 지나는 광선이 평면과 교차하는 점을 구해 그림자 모델 생성
방향성 광원의 평면 투영

▶ 그림자 텍스쳐 동적 생성
객체의 모양과 같은 그림자 텍스쳐 생성
① 카메라를 조명 위치로 이동, 카메라 변환 행렬을 사용하여 설정
② 텍스쳐를 생성하여 렌더 타겟으로 설정, 렌더 타겟을 검정색으로 지움
③ 객체를 흰색으로 렌더링
④ 후면버퍼를 렌더 타겟으로 설정
⑤ 그림자 텍스쳐를 렌더링

▶ 투영 텍스쳐 매핑
① 조명(프로젝터)을 카메라로 생각할 수 있음
② 점(Px, Py, Pz)을 투영 좌표계로 변환(투영)
③ 텍스쳐 좌표계로 변환
④ 점(Px, Py, Pz)의 색상을 텍스쳐로 변환

▶ 그림자 매핑 - 조명을 카메라로 가정하고 렌더링 과정으로 이해
조명이 객체에 도달하면 여부를 계산하여 텍스쳐(깊이 맵)에 저장
① 카메라를 조명 위치에서 생성, 카메라 변환 행렬 V를 생성하여 설정, 투영 변환 행렬 P를 생성하여 설정
② 텍스쳐를 생성하여 깊이스텐실 버퍼로 설정, 렌더 타겟은 필요 없음
③ 그림자 맵 변환 행렬을 위한 상수 버퍼를 생성, 월드 좌표계의 점을 조명 좌표계로 변환하기 위한 변환 행렬
④ 객체들을 렌더링, 투명한 픽셀은 깊이 값을 출력할 필요 없음

▶ 그림자 렌더링
① 렌더 타겟과 깊이 버퍼 설정
② 그림자 맵 텍스쳐를 셰이더 리소스로 연결
③ 씬을 렌더링하면서 각 픽셀이 그림자에 해당하는 가를 결정
④ 정점 셰이더에서 렌더링할 메쉬의 각 정점의 월드 좌표를 조명 좌표계로 변환, 조명 좌표계를 텍스쳐 좌표계로 변환
⑤ 픽셀 셰이더에서 각 픽셀에 대한 조명 좌표계의 거리를 구함
⑥ 그림자 맵 텍스쳐의 깊이값과 픽셀의 깊이값을 비교하여 그림자 여부를 판단, 그림자에 해당하는 픽셀의 조명 효과를 줄이거나 제거(검은색으로 그림)

▶ 투영 텍스쳐링
점 P에 대한 그림자 맵(텍스쳐) 샘플링 UV 좌표의 계산
① 점 P를 조명의 투영 평면으로 투영 그림자 맵을 생성할 때의 변환 행렬이 필요
② 투영된 좌표를 텍스쳐 좌표로 변환, 투영된 좌표는 -1 <= x, y <= 1
XMMaterixPerspectiveFovLH(): 원근 투영 변환 행렬을 생성하여 반환(카메라 좌표계)
XMMatrixOrthographicLH(): 직교 투영 변환 행렬을 생성
XMMatrixOrthographicOffCenterLH(): 직교 투영 변환 행렬을 생성

▶ 그림자 맵 문제
정밀도 문제: 그림자 여드름, 물결 패턴
원근/투영으로 인한 계단 현상
물결치는 엣지

▶ 바이어스
그림자 맵의 거리에 바이어스를 더해서 그림자 여드름 해결
바이어스를 동적으로 계산해주는 것이 GPU에 있음
-> RASTERIZER_DESC 구조체의
- DepthDias: 각 픽셀에 더해질 깊이 바이어스
- DepthBiasClamp: 픽셀의 깊이 바이어스의 최대값
- SlopeScaledDepthBias: 픽셀의 기울기에 따라 바이어스를 조절

▶ 그림자 맵
조명 투영 공간을 렌더링 카메라 투영 공간(절두체)에 가급적 밀접하게 만들어야 함
그림자 맵의 커버리지를 증가시킴
① 렌더링 카메라 절두체의 8개 꼭지점을 조명좌표계로 변환
② 변환된 x좌표와 y좌표들의 최소값과 최대값을 직교 투영 공간으로 사용

▶ PDF - 뭔가 시험에 나올법함
주변의 텍셀을 무작위로 샘플링, 포인트 필터를 반드시 써야 함
① 샘플러 상태 객체 필터링 좌표에 대한 깊이 값 검사(D3D12_FILTER_MIN_MAG_MIP_POINT)
② 텍스쳐 좌표에 대한 샘플링
③ 깊이 값 d에 대한 그림자 맵 검사
④ 검사 결과에 대한 선형 보간
SampleCmpLevelZero: 현재 UV 좌표에 해당하는 픽셀의 그림자맵 비교 검사를 GPU에서 해줌

▶ 방향성 조명 그림자
전체 씬에 대한 그림자 계산에 사용

▶ 원근 투영 에일리어싱
카메라에 가까운 그림자 맵의 픽셀들이 확대되어 그림자에 계단 현상이 발생, 그림자 맵을 생성할 때 원근 투영에 의해 깊이 값이 저장되는 텍셀 수가 달라짐

▶ 직렬 그림자 맵
방향성 조명은 아주 넓은 영역을 비춤
카메라 절두체를 여러 영역으로 나누고 각 영역을 같은 해상도의 그림자 맵으로 생성